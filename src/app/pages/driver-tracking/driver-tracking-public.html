<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Tracking - Public Access</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header h1 {
            color: #2d3748;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .tracking-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tracking-btn:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .tracking-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .refresh-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .refresh-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .status-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 16px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
        }

        .status-item-icon {
            font-size: 1.5rem;
            opacity: 0.7;
        }

        .status-label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .status-value {
            color: #4a5568;
            font-size: 0.9rem;
        }

        .map-container {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }

        .tracking-map {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #4299e1;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 16px !important;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f56565;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .instructions {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }

        .info-section {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }

        .driver-info {
            font-size: 1.1rem;
            color: #2d3748;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .header {
               ÁÅµÊ¥ª-direction: column;
                gap: 16px;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .tracking-map {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Driver Tracking</h1>
            <button id="trackingBtn" class="tracking-btn">
                Start Tracking
            </button>
        </div>

        <div class="info-section">
            <div class="driver-info">
                <strong>Driver ID:</strong> <span id="driverInfo">Loading...</span>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Loading driver location...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="statusCard" class="status-card" style="display: none;">
            <h2 style="margin-bottom: 16px; color: #2d3748;">Driver Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-item-icon">üïê</div>
                    <div>
                        <div class="status-label">Last Updated</div>
                        <div class="status-value" id="lastUpdated">Never</div>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-item-icon">üë§</div>
                    <div>
                        <div class="status-label">Driver ID</div>
                        <div class="status-value" id="driverIdDisplay">Unknown</div>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-item-icon">üìÖ</div>
                    <div>
                        <div class="status-label">Booking ID</div>
                        <div class="status-value" id="bookingIdDisplay">Unknown</div>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-item-icon">üîç</div>
                    <div>
                        <div class="status-label">Status</div>
                        <div class="status-value" id="trackingStatus">Inactive</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="trackingMap" class="tracking-map"></div>
        </div>

        <div class="instructions">
            <h3 style="margin-bottom: 12px; color: #2d3748;">‚ÑπÔ∏è How to Use</h3>
            <p style="color: #4a5568; line-height: 1.6;">
                This page provides real-time tracking of driver locations. Click "Start Tracking" 
                to begin monitoring the driver's current location. The location updates automatically 
                every 5 seconds and shows the driver's position on the map. This page is publicly 
                accessible and doesn't require authentication.
            </p>
        </div>
    </div>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_pMgEY3hnhEpXOjOM7Kgtede5PE-K-7Y&callback=initMap" async defer></script>

    <script>
        // Configuration
        const apiBaseUrl = 'http://localhost:5170'; // Change this to your API URL
        
        // Global variables
        let map;
        let driverMarker;
        let trackingInterval;
        let currentDriverId = '';
        let isTracking = false;
        
        // Get driver ID from URL parameter
        function getDriverIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const driverId = urlParams.get('driverId') || urlParams.get('driver');
            return driverId || 'driver123'; // Default fallback
        }
        
        // Initialize Google Maps
        function initMap() {
            const defaultCenter = { lat: -26.2041, lng: 28.0473 }; // Johannesburg
            
            map = new google.maps.Map(document.getElementById('trackingMap'), {
                center: defaultCenter,
                zoom: 14,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });
            
            // Initialize driver marker with pulsating circle and car icon
            driverMarker = new google.maps.Marker({
                position: defaultCenter,
                map: map,
                title: 'Driver Location',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60">
                            <!-- Pulsating circle background -->
                            <circle cx="30" cy="30" r="25" fill="#DC2626" stroke="white" stroke-width="4" opacity="0.8">
                                <animate attributeName="r" values="25;30;25" dur="2s" repeatCount="indefinite"/>
                                <animate attributeName="opacity" values="0.8;1;0.8" dur="2s" repeatCount="indefinite"/>
                            </circle>
                            <!-- Car icon inside circle -->
                            <path d="M43 15c-.8-5.5-4.2-6-7.5-6h-11C21.2 9 17.8 9.5 17 15L13 27v12c0 .8.6 1.5 1.5 1.5h1.5c.8 0 1.5-.7 1.5-1.5v-1.5h18v1.5c0 .8.7 1.5 1.5 1.5H39c.8 0 1.5-.7 1.5-1.5V27l-1.7-12zM18 27c-1.2 0-2.2-1-2.2-2.2S16.8 22.5 18 22.5s2.2 1 2.2 2.2S19.2 27 18 27zm18 0c-1.2 0-2.2-1-2.2-2.2s1-2.2 2.2-2.2 2.2 1 2.2 2.2-1 2.2-2.2 2.2zM14 24l2.2-6.8h17.6L39 24H14z" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(60, 60),
                    anchor: new google.maps.Point(30, 30)
                }
            });
            
            console.log('üó∫Ô∏è Google Maps initialized successfully');
            
            // Initialize page with driver ID from URL
            initializePage();
        }
        
        // Initialize page with driver ID from URL
        function initializePage() {
            currentDriverId = getDriverIdFromUrl();
            document.getElementById('driverInfo').textContent = currentDriverId;
            console.log('üìã Driver ID loaded from URL:', currentDriverId);
        }
        
        // API function to get driver location
        async function getDriverLocation(driverId) {
            try {
                const response = await fetch(`${apiBaseUrl}/vehicles/trackDriver/${driverId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('‚ùå Error fetching driver location:', error);
                throw error;
            }
        }
        
        // Update driver location on map
        function updateDriverLocation(location) {
            if (location && location.latitude && location.longitude) {
                const newPosition = {
                    lat: parseFloat(location.latitude),
                    lng: parseFloat(location.longitude)
                };
                
                // Update marker position
                driverMarker.setPosition(newPosition);
                
                // Smoothly center map on new position
                map.panTo(newPosition);
                
                console.log('üìç Driver location updated:', newPosition);
                return true;
            }
            return false;
        }
        
        // Start or stop tracking
        async function toggleTracking() {
            if (!isTracking) {
                // Start tracking
                await startTracking();
            } else {
                // Stop tracking
                stopTracking();
            }
        }
        
        // Start tracking
        async function startTracking() {
            if (!currentDriverId) return;
            
            // Update button
            const btn = document.getElementById('trackingBtn');
            btn.textContent = 'Stop Tracking';
            btn.className = 'refresh-btn';
            btn.onclick = toggleTracking;
            
            isTracking = true;
            
            // Show loading and hide error
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('error').style.display = 'none';
            document.getElementById('statusCard').style.display = 'none';
            
            try {
                // Get initial location
                const location = await getDriverLocation(currentDriverId);
                
                if (location && location.success !== false) {
                    updateDriverLocation(location);
                    
                    // Update status display
                    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
                    document.getElementById('driverIdDisplay').textContent = location.driverId || currentDriverId;
                    document.getElementById('bookingIdDisplay').textContent = location.bookingId || 'Not specified';
                    document.getElementById('trackingStatus').textContent = 'Active';
                    
                    // Show status card
                    document.getElementById('statusCard').style.display = 'block';
                    
                    // Start interval tracking
                    clearInterval(trackingInterval);
                    trackingInterval = setInterval(async () => {
                        try {
                            const newLocation = await getDriverLocation(currentDriverId);
                            if (newLocation && newLocation.success !== false) {
                                updateDriverLocation(newLocation);
                                document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
                            }
                        } catch (error) {
                            console.error('‚ùå Background tracking error:', error);
                        }
                    }, 5000); // Update every 5 seconds
                    
                    console.log('üöÄ Tracking started for driver:', currentDriverId);
                } else {
                    throw new Error('No active location found for this driver');
                }
            } catch (error) {
                document.getElementById('error').innerHTML = `
                    ‚ö†Ô∏è Error: ${error.message}<br>
                    <small>Make sure the API is running and the driver ID is correct.</small>
                `;
                document.getElementById('error').style.display = 'block';
                document.getElementById('trackingStatus').textContent = 'Error';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // Stop tracking
        function stopTracking() {
            if (!isTracking) return;
            
            isTracking = false;
            
            // Stop interval
            clearInterval(trackingInterval);
            trackingInterval = null;
            
            // Update button
            const btn = document.getElementById('trackingBtn');
            btn.textContent = 'Start Tracking';
            btn.className = 'tracking-btn';
            btn.onclick = toggleTracking;
            
            // Update status
            document.getElementById('trackingStatus').textContent = 'Stopped';
            
            console.log('‚èπÔ∏è Tracking stopped for driver:', currentDriverId);
        }
        
        // Manual refresh (when button shows refresh)
        async function refreshLocation() {
            if (!currentDriverId || !isTracking) return;
            
            try {
                const location = await getDriverLocation(currentDriverId);
                
                if (location && location.success !== false) {
                    updateDriverLocation(location);
                    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
                    
                    if (document.getElementById('statusCard').style.display === 'none') {
                        document.getElementById('driverIdDisplay').textContent = location.driverId || currentDriverId;
                        document.getElementById('bookingIdDisplay').textContent = location.bookingId || 'Not specified';
                        document.getElementById('trackingStatus').textContent = 'Active';
                        document.getElementById('statusCard').style.display = 'block';
                    }
                    
                    console.log('üîÑ Location refreshed successfully');
                } else {
                    throw new Error('No location found');
                }
            } catch (error) {
                document.getElementById('error').innerHTML = `‚ö†Ô∏è ${error.message}`;
                document.getElementById('error').style.display = 'block';
            }
        }
        
        // Event listeners
        document.getElementById('trackingBtn').addEventListener('click', toggleTracking);
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (trackingInterval) {
                clearInterval(trackingInterval);
            }
        });
        
        console.log('üöÄ Driver Tracking Public Page Loaded');
        console.log('üì° API Base URL:', apiBaseUrl);
        console.log('üó∫Ô∏è Waiting for Google Maps to load...');
    </script>
</body>
</html>